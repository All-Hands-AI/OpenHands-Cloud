name: Scan Docker Images

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: all-hands-ai/runtime-api
on:
  pull_request:
jobs:
  scan_docker_images:
    name: Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
      actions: read
    steps:

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        # This only reports, does not fail the build on CVE.
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-e52f4e0
          # trixie: sha-e52f4e0
          # default: sha-07c8732
          format: 'sarif'
          output: 'trivy-results-raw.sarif'
          timeout: '10m'
          scanners: 'vuln'  # Only scan vulnerabilities, not secrets/config
          severity: 'CRITICAL,HIGH'  # Skip LOW and MEDIUM severity
      - name: Customize SARIF with image flavor
        run: |
          # Modify the tool name to include the image flavor
          jq --arg flavor "${{ env.IMAGE_NAME }}" \
            '.runs[0].tool.driver.name = "Trivy (" + $flavor + ")"' \
            trivy-results-raw.sarif > trivy-results.sarif
          echo "Modified tool name to: $(jq -r '.runs[0].tool.driver.name' trivy-results.sarif)"
      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'security/container-${{ env.IMAGE_NAME }}'